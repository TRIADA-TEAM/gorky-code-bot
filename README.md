# Документация по проекту "AI-помощник туриста"

Этот документ содержит подробное описание архитектуры, функционала и процесса установки телеграм-бота для генерации персональных туристических маршрутов по Нижнему Новгороду.

## 1. Обзор проекта

"AI-помощник туриста" — это телеграм-бот, разработанный в рамках хакатона GORKYCODE 2025. Его основная задача — создавать персонализированные пешеходные маршруты для жителей и гостей Нижнего Новгорода.

Бот взаимодействует с пользователем в формате диалога, запрашивая три ключевых параметра:
1.  **Интересы:** Что пользователь хотел бы увидеть (например, "стрит-арт, история, красивые виды").
2.  **Время:** Сколько часов пользователь готов потратить на прогулку.
3.  **Местоположение:** Отправная точка маршрута (геопозиция или выбранная точка на карте).

На основе этих данных бот генерирует и предлагает оптимизированный маршрут, который включает в себя от 3 до 5 релевантных локаций, а также, при необходимости, места для перекуса.

## 2. Ключевые возможности

- **Персонализированные маршруты:** Маршруты строятся динамически под каждый уникальный запрос пользователя.
- **Гибридная система поиска:**
    - **Основной поиск (на основе тегов):** Быстрый и детерминированный поиск по заранее сгенерированным тегам объектов. Обеспечивает высокую релевантность для большинства запросов.
    - **Семантический поиск (Fallback RAG):** Если основной поиск не дал результатов, система переключается на семантический поиск (Retrieval-Augmented Generation) с использованием векторных представлений (embeddings). Это позволяет находить релевантные места даже по нечетким или нестандартным запросам.
- **Интеграция заведений питания:**
    - **Автоматическое добавление:** Для маршрутов длиной 3 часа и более бот автоматически предлагает подходящие кафе на пути.
    - **Явный запрос:** Если пользователь прямо указывает в интересах желание поесть (например, "где поесть", "ресторан"), бот ищет заведения, соответствующие его интересам.
- **Оптимизация маршрута:** Алгоритм строит маршрут, минимизируя время в пути между точками, используя эвристику ближайшего соседа.
- **Реалистичный расчет времени:** Для расчета времени и расстояний пешего передвижения используется внешний API **2GIS Distance Matrix**, что обеспечивает высокую точность.
- **Интерактивная карта:** В конце бот присылает ссылку на 2GIS, где визуализирован весь построенный маршрут.
- **Продуманный UX:**
    - Валидация вводимого времени (поддержка дробных чисел, ограничение в 16 часов).
    - Запрос подтверждения для долгих прогулок (более 8 часов).
    - Возможность легко создать новый маршрут после получения предыдущего.

## 3. Техническая архитектура

Система состоит из нескольких ключевых модулей, работающих вместе для сбора данных, их обработки и генерации маршрута.

### 3.1. Подготовка данных

Перед запуском основного приложения необходимо подготовить данные с помощью скриптов из директории `scripts/`.

1.  **`scripts/prepare_data.py`**:
    - Обрабатывает исходный файл `cultural_objects_mnn.xlsx`.
    - Генерирует `src/data/places.json` — основной файл с данными о достопримечательностях.
    - Для каждого объекта создает набор **тегов** на основе его названия, описания и категории. Эти теги — основа для быстрого поиска.
    - Создает `src/data/synonyms.json` для расширения запросов пользователя (например, "прогуляться" -> "парк", "набережная").
    - Создает `src/data/category_times.json` с примерным временем посещения для каждой категории объектов.

2.  **`scripts/prepare_food_data.py`**:
    - Аналогично обрабатывает `food_places.xlsx`.
    - Генерирует `src/data/food_places.json`, `src/data/food_synonyms.json` и `src/data/food_category_times.json`.
    - Присваивает всем заведениям тег `'ед'` для легкой идентификации.

3.  **`scripts/prepare_embeddings.py`**:
    - Создает векторные представления (embeddings) для всех достопримечательностей на основе их текстовых описаний.
    - Сохраняет эмбеддинги в `src/data/embeddings.npy` и ID мест в `src/data/place_ids.json`. Эти файлы используются для семантического поиска (RAG fallback).

### 3.2. Логика генерации маршрута (`src/ai/route_logic.py`)

Это ядро системы, реализованное в классе `RouteBuilder`.

**Процесс генерации:**

1.  **Токенизация и расширение запроса:** Интересы пользователя разбиваются на слова (токены), которые затем расширяются синонимами из `synonyms.json`.
2.  **Поиск кандидатов:**
    - **`_find_places`**: Выполняется поиск по тегам в `places.json`. Места, у которых есть совпадения по тегам, становятся кандидатами. Внедрена система скоринга, которая, например, понижает приоритет "макетов" по сравнению с реальными объектами.
    - **`_find_food_places`**: Если нужно, выполняется аналогичный поиск по `food_places.json`.
3.  **Семантический Fallback (`src/ai/rag_fallback.py`):**
    - Если `_find_places` не нашел ни одного кандидата, управление передается в `find_places_by_rag`.
    - Этот модуль загружает векторные представления (`embeddings.npy`) и выполняет поиск семантически близких мест к исходному запросу пользователя с помощью `SentenceTransformer` и `faiss-cpu`.
    - Пользователь уведомляется о том, что используется альтернативный метод поиска.
4.  **Оптимизация маршрута (`_optimize_route_by_geodesic`):**
    - В качестве отправной точки используется локация пользователя.
    - Алгоритм итеративно выбирает **ближайшую** (по геодезическому расстоянию) не посещенную точку из списка кандидатов.
    - Точка добавляется в маршрут, если общее время (прогулка + посещение) не превышает лимит, заданный пользователем.
    - В процессе итерации алгоритм также пытается вставить в маршрут заведения питания, соблюдая временные интервалы.
5.  **Получение реальных времен в пути (`_get_route_travel_times_from_2gis`):**
    - После того как основной маршрут из 3-5 точек составлен, система делает **один** запрос к API 2GIS, передавая всю последовательность точек.
    - API возвращает матрицу расстояний и времен в пути между всеми точками.
    - Из этой матрицы извлекаются нужные значения для последовательного маршрута.
6.  **Форматирование вывода (`_format_route_text`):**
    - Генерируется текстовое описание маршрута для пользователя с указанием последовательности, адресов, времени в пути и времени на посещение.
    - В конце добавляется итоговая сводка: общее время прогулки и общая дистанция.
    - Генерируется URL для 2GIS карты.

### 3.3. Взаимодействие с пользователем (`src/handlers/`)

- **`handlers.py`**: Содержит FSM (Finite State Machine) для сбора данных от пользователя (интересы -> время -> локация).
- **`commands.py`**: Обрабатывает команду `/start`.
- **`callbacks.py`**: Обрабатывает нажатия на inline-кнопки (например, "Составить новый маршрут").
- **`content/`**: Вся текстовая часть (сообщения, названия кнопок) вынесена в эту директорию для легкой локализации и поддержки.

## 4. Структура проекта

```
guide-bot/
├── .env.example              # Пример файла с переменными окружения
├── requirements.txt          # Зависимости Python
├── main.py                   # Главный файл для запуска бота
├── documentation.md          # Этот файл
├── scripts/                  # Скрипты для подготовки данных
│   ├── prepare_data.py
│   ├── prepare_food_data.py
│   └── prepare_embeddings.py
├── src/
│   ├── ai/                   # Модули, отвечающие за AI-логику
│   │   ├── route_logic.py    # Основная логика построения маршрута
│   │   ├── rag_fallback.py   # Логика семантического поиска
│   │   └── *.xlsx            # Исходные данные
│   ├── data/                 # Сгенерированные данные для работы бота
│   │   ├── places.json
│   │   ├── food_places.json
│   │   ├── embeddings.npy
│   │   └── ...
│   ├── handlers/             # Обработчики сообщений и колбэков от Telegram
│   │   ├── handlers.py
│   │   ├── commands.py
│   │   └── callbacks.py
│   └── content/              # Текстовый контент и клавиатуры
│       ├── messages.py
│       └── keyboards.py
└── ...
```

## 5. Установка и запуск

1.  **Клонируйте репозиторий:**
    ```bash
    git clone <repository_url>
    cd guide-bot
    ```

2.  **Создайте и активируйте виртуальное окружение:**
    ```bash
    python -m venv .venv
    source .venv/bin/activate  # для Linux/macOS
    .venv\Scripts\activate  # для Windows
    ```

3.  **Установите зависимости:**
    ```bash
    pip install -r requirements.txt
    ```

4.  **Настройте переменные окружения:**
    - Скопируйте файл `.env.example` в `.env`.
    - Впишите в `.env` ваш токен для телеграм-бота и токен для 2GIS API.
    ```ini
    BOT_TOKEN="YOUR_TELEGRAM_BOT_TOKEN"
    GIS_TOKEN="YOUR_2GIS_API_TOKEN"
    ```

5.  **Подготовьте данные:**
    - Запустите скрипты для обработки данных. **Внимание:** этот шаг необходимо выполнить перед первым запуском бота.
    ```bash
    python scripts/prepare_data.py
    python scripts/prepare_food_data.py
    python scripts/prepare_embeddings.py
    ```

6.  **Запустите бота:**
    ```bash
    python main.py
    ```
